var win,menuType,type,tabid,taburl,tabtitle,zoomLevel,counter,ratio,scrollBar,data,tempDataUrl,currentWindowId,currentTabId,currentTabIndex,request,dataURL=[],newClickVersion="4.3.29",centerW=0,centerH=0,cameraStream=null,currentRecordingTabId="",currentRecordingTabTitle="",currentRecordingTabUrl="",tabCameraClosedManually=!1,isEmbedCamera=!1,isShowToolbar=!1,currentversion=chrome.runtime.getManifest().version,tabids={},recordType="",recordingStatus="",cVideo=null,centerOffX=0,centerOffY=0,isCopyAction=!1,userAction="annotate",desktopCaptureInterval=null,uploadQueues={},isSaveOnLine=!1,temImageId=1,personType=0,isScrollCapturing=!1,curentCaptureTabid=-1,currentWindowHeight=0,currentTemId=0,userStop=!1,contentCanScroll=!1;const maxCaptureHeight=1e5;var actionFrom="",bgRegions=[],bottomClip=null,contentClip=null,topCapturePostion=null,devicePixelRatio=window.devicePixelRatio,scrollCatureTimes=[],contentInsertStatus={},isIncognito=!1,toolbarSettings={mouseMode:"mouse",currentMouse:"default",drawMode:"freeline",currentColor:"red",isCollapse:!1,isPaused:!1};function resetToolbarSettings(){toolbarSettings={mouseMode:"mouse",currentMouse:"default",drawMode:"freeline",currentColor:"red",isCollapse:!1,isPaused:!1}}function sendMessageToTab(e,t,a){chrome.tabs.sendMessage(e,t,{frameId:0},a)}function sendMessage(e,t){chrome.runtime.sendMessage(e,t)}function getCurrentTab(e){chrome.tabs.query({active:!0,currentWindow:!0},(function(t){e(t[0])}))}if(window.onload=function(){(cVideo=document.querySelector("#camera-video")).onloadedmetadata=function(){cVideo.requestPictureInPicture()},cVideo.onleavepictureinpicture=function(){stopCameraStream()},cVideo.onemptied=function(){document.exitPictureInPicture().catch((function(e){}))}},getPersonType(),localStorage.msObj){var options=JSON.parse(localStorage.msObj),resetKey=!1;"R"==options.visible.key&&(options.visible.key="V",resetKey=!0),"R"==options.selected.key&&(options.selected.key="S",resetKey=!0),"R"==options.entire.key&&(options.entire.key="E",resetKey=!0),resetKey&&(localStorage.msObj=JSON.stringify(options))}else localStorage.msObj='{"visible":{"enable":true,"key":"V"},"selected":{"enable":true,"key":"S"},"entire":{"enable":true,"key":"E"}}';function insertFile(e,t,a){return new Promise((function(r,o){"css"===e?chrome.tabs.insertCSS(t,{file:a},(function(e){r(e)})):"script"===e&&chrome.tabs.executeScript(t,{file:a},(function(e){r(e)}))}))}function broadCast(e,t){"desktop"===recordType&&chrome.tabs.query({},(function(a){a.forEach((function(a){a.id!==t&&sendMessageToTab(a.id,e)}))}))}function getCameraStream(e,t,a){window.navigator.mediaDevices.getUserMedia({video:{deviceId:e,echoCancellation:!1,width:{ideal:1280},height:{ideal:720}}}).then((function(e){t(e)})).catch((function(e){}))}function isNotAcceptedTab(e){return e.match(/chrome(.*):\/\//)||e.match(/edge(.*):\/\//)||e.match(/chrome-extension:\/\//)||e.match(/https:\/\/chrome.google.com\/webstore/i)||e.match(/https:\/\/ntp.msn.cn\/edge\/ntp/i)||e.match(/about:blank/)&&!1}function initToolbar(){"tab"===recordType?currentRecordingTabId?insertContentScript(currentRecordingTabId).then((function(){sendMessageToTab(currentRecordingTabId,{action:"setup-toolbar"})})):getCurrentTab((function(e){e&&(isNotAcceptedTab(e.url)||(insertContentScript(e.id).then((function(){sendMessageToTab(e.id,{action:"setup-toolbar"})})),currentRecordingTabId=e.id))})):"desktop"===recordType&&chrome.tabs.query({},(function(e){e.forEach((function(e){insertContentScript(e.id).then((function(){sendMessageToTab(e.id,{action:"setup-toolbar"})})).catch((function(e){}))}))}))}function initCamera(e){getCameraStream(e,(function(e){if(cameraStream=e,"tab"===recordType)currentRecordingTabId?sendMessageToTab(currentRecordingTabId,{action:"setup-camera"}):getCurrentTab((function(e){isNotAcceptedTab(e.url)?stopCameraStream():(sendMessageToTab(e.id,{action:"setup-camera"}),currentRecordingTabId=e.id)})),isEmbedCamera=!0,tabCameraClosedManually=!1;else{var t=document.querySelector("#camera-video");t.srcObject=e,t.play()}}))}function stopCamera(){stopCameraStream(),"tab"===recordType?sendMessageToTab(currentRecordingTabId,{action:"stop-camera"}):sendMessage({action:"stop-camera"})}function stopCameraStream(){cameraStream&&(cameraStream.getTracks().forEach((function(e){e.stop()})),cameraStream=null,cVideo.srcObject=null)}function enablePriceCompare(){localStorage.pcnotification="true",localStorage.popupnotification="true",localStorage.barnotification="true",localStorage.show_feature_bar="false",refreshOptions()}function disablePriceCompare(){localStorage.pcnotification="false",localStorage.popupnotification="false",localStorage.barnotification="false","never"!==localStorage.show_feature_bar&&(localStorage.show_feature_bar="true"),refreshOptions()}function tryFinishCapture(e,t){if(e==curentCaptureTabid&&isScrollCapturing){userStop=!0,counter=dataURL.length,ratio={x:1,y:1},scrollBar={x:!1,y:!0},sendMessageToTab(tabid,{action:"restorebar"});var a,r=currentTemId;if("copy"==userAction)copySelectAction(e);else if(isAutoSaveOnline()&&isSaveOnLine&&currentTemId>0)(a=getQueueByImageId(currentTemId))||(a=new UploadQueue(r),uploadQueues[currentTemId]=a),a.finishCapture(),sendMessageToTab(tabid,{action:"destroy_selected"});else newTab();if(r>0)(a=getQueueByImageId(r))&&!a.imageUrl?a.errMsg=a.errMsg?a.errMsg+t+" ":t+" ":a&&uploadLog(a.imageId,{clientCreateTime:a.clientCreateTime,errMsg:a.errMsg+t+" "})}}function captureVisible(){type="visible",dataURL=[],getSelectedTab((function(){var t=0;"save"==userAction&&(t=++temImageId,initImageId(tabtitle,taburl,e,t));chrome.windows.update(currentWindowId,{focused:!0},(function(){chrome.tabs.update(currentTabId,{active:!0},(function(){chrome.tabs.captureVisibleTab(null,{format:"png"},(function(a){if(a){var r=document.createElement("IMG");if(r.src=a,dataURL.push(r),"copy"==userAction)copySelectAction(currentTabId);else if("save"==userAction){if(sendMessageToTab(tabid,{action:"destroy_selected"}),!isAutoSaveOnline()||!isSaveOnLine)return void newTab();getQueueByImageId(t)||(uploadQueues[t]=new UploadQueue(t)),handleCurrentCapture(r,1,!0,t)}else{if(!isAutoSaveOnline()&&0==centerW)return void newTab();sendMessageToTab(tabid,{action:"dataURL",dataURL:a,cl:centerOffX,ct:centerOffY,ch:centerH,cw:centerW,incognito:isIncognito,userAction,autoOnline:!0,actionType:e,format:localStorage.format})}}}))}))}))}));var e="visible";"selected"==menuType&&(e="visible_selected")}function getUserSigninStatus(e){chrome.cookies.get({url:baseUrl,name:"screenshot_personal_uid"},(function(t){t?e&&e(!0):e&&e(!1)}))}function getPersonType(e){chrome.cookies.get({url:"https://www.awesomescreenshot.com",name:"screenshot_personal_type"},(function(t){personType=t?t.value:0,e&&e(personType)}))}function isAutoSaveOnline(){return"local"!==localStorage["save-capture-location"]}function getCaptureSatus(){var e=!0;for(var t in uploadQueues){uploadQueues[t].captureFinish||(e=!1)}return e}function copySelectAction(e){userAction="",isScrollCapturing=!1,sendMessageToTab(e,{action:"destroy_selected"}),dataURLGenerator(menuType,type,centerOffX,centerOffY,centerW,centerH,counter,ratio,scrollBar,dataURL,(function(t){sendMessageToTab(e,{action:"copytoclipboard",obj:t})}))}function dataURLGenerator(e,t,a,r,o,n,i,c,s,l,d){var u,p,g,m,b,h,f,S=document.createElement("IMG"),T=document.createElement("canvas"),v=T.getContext("2d"),y=getScrollbarWidth(),w=0,C=0;function I(){T.width=g,T.height=m}S.onload=function(){switch(u=this.width,p=this.height,t){case"visible":"selected"===e?(g=o,m=n,U=a,j=r):"desktop"===e||"upload"===e?(g=u,m=p,U=0,j=0):(g=u-y,m=p,U=0,j=0),I(),v.drawImage(this,U,j,g,m,0,0,g,m),d(T.toDataURL());break;case"entire":var k=C=w=0,x=l.length,_=i,R=Math.round(x/_);function M(e,t,a,r,o,n,i,c,s){e?(i=k*p,k==R-1&&(a=p-b,o=s=b),S.onload=function(){v.drawImage(this,t,a,r,o,n,i,c,s),++k>R-1&&L(),M(l[++w],t,a,r,o,n,i,c,s)},S.src=e.src):d(T.toDataURL())}function L(){++C>_-1||(C==_-1?(U=u-undefined,A=h=g-C*u,O=C*u):(U=0,A=h=u,O=C*u),j=0,W=f=p,D=0,M(l[w=(k=0)+C*R],U,j,A,W,O,D,h,f))}if(!s.x&&s.y){R=x,b=p*c.y,g="selected"==e?o:u,m=b?p*(R-1)+b:p*R,I();var U=0,A=h=u,O=0,j=0,W=f=p,D=0;"selected"==e&&a&&(U=a),M(l[w],U,j,A,W,O,D,h,f)}}},S.src=l[0].src}function getScrollbarWidth(){var e=document.createElement("p");e.style.width="100%",e.style.height="200px";var t=document.createElement("div");t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.visibility="hidden",t.style.width="200px",t.style.height="150px",t.style.overflow="hidden",t.appendChild(e),document.body.appendChild(t);var a=e.offsetWidth;t.style.overflow="scroll";var r=e.offsetWidth;return a==r&&(r=t.clientWidth),document.body.removeChild(t),a-r}function captureVisibled(){type="visible",getSelectedTab(checkContentScript)}function captureSelected(){type="selected",getSelectedTab(checkContentScript)}function captureEntire(){type="entire",getSelectedTab(checkContentScript)}function getSelectedTab(e){getCurrentTab((function(t){tabid=t.id,taburl=t.url,tabtitle=t.title,isIncognito=t.incognito,chrome.tabs.getZoom(t.id,(function(t){zoomLevel=t,null!=e&&e()}))}))}function insertContentScript(e){return new Promise((function(t,a){chrome.tabs.executeScript(e,{code:'typeof isContentScriptLoaded === "undefined"'},(function(r){chrome.runtime.lastError||(r?r[0]?contentInsertStatus[e]?setTimeout((()=>{t()}),250):(contentInsertStatus[e]=!0,insertFile("script",e,"javascripts/libs/jquery-3.4.0.min.js").then(insertFile("script",e,"javascripts/libs/dragresize.js")).then(insertFile("script",e,"javascripts/jquery.draggable.js")).then(insertFile("script",e,"javascripts/libs/jquery-ui-custom.min.js")).then(insertFile("css",e,"stylesheets/selected.css")).then(insertFile("script",e,"javascripts/bundles/content.bundle.js")).then((function(){delete contentInsertStatus[e],t()}))):t():a&&a())}))}))}function checkContentScript(){chrome.tabs.executeScript(tabid,{file:"javascripts/isload.js"})}function saveAndScroll(e,t,a){pushDataURL(e,t)}function pushDataURL1(e){return new Promise((function(t,a){chrome.tabs.update(e,{active:!0},(function(e){chrome.tabs.captureVisibleTab(e.windowId,{format:"png"},(function(e){chrome.runtime.lastError?a("captureError"):t(e)}))}))}))}function prepareCapture(e,t,a){var r=document.createElement("CANVAS"),o=r.getContext("2d"),n=document.createElement("IMG");n.onload=function(){var e=this.width;this.height;r.width=e,r.height=t.height,o.drawImage(this,t.x,t.y,t.width,t.height,t.x,0,t.width,t.height),r.toBlob((function(e){a(e)}))},n.src=e}function handleCaptureDelayTime(e){var t=Date.now();scrollCatureTimes.push(e);var a=t-e;if(a>=1e3)return 0;var r=scrollCatureTimes.length;if(1===r)return a>=400?0:a>250?100:250;var o=e-scrollCatureTimes[r-2]+a;if(o>1e3)return 0;var n=1020-o;return n<50?50:n}function pushDataURL(e,t){var a=Date.now();chrome.tabs.update(e,{active:!0},(function(r){chrome.tabs.captureVisibleTab(r.windowId,{format:"png"},(function(r){var o=!1;if(r){var n=document.createElement("IMG");if(n.src=r,dataURL.push(n),"save"==userAction)try{if(isAutoSaveOnline()&&dataURL.length>=2&&isSaveOnLine&&t>0){var i=dataURL.length;(c=getQueueByImageId(t))||(c=new UploadQueue(t),uploadQueues[t]=c),c.height<("image/png"==c.format?1e5:6e4)&&!c.captureFinish?(c.height+=currentWindowHeight,handleCurrentCapture(dataURL[i-2],dataURL.length-1,!1,t)):tryFinishCapture(e,"maxHeight")}}catch(e){(c=getQueueByImageId(t))&&(c.imageUrl?uploadLog(c.imageId,{clientCreateTime:c.clientCreateTime,errMsg:e.toString()+"pushDataURL; "+c.errMsg}):c.errMsg=c.errMsg?c.errMsg+e.toString()+"pushDataURL; ":e.toString()+"pushDataURL; ")}}else{var c;if(RegExp(/MAX_CAPTURE_VISIBLE_TAB_CALLS_PER_SECOND/).test(chrome.runtime.lastError.message))o=!0;else(c=getQueueByImageId(t))&&(c.imageUrl?uploadLog(c.imageId,{clientCreateTime:c.clientCreateTime,errMsg:" chrome.tabs.captureVisibleTab; "+c.errMsg}):c.errMsg=c.errMsg?c.errMsg+" chrome.tabs.captureVisibleTab; ":" chrome.tabs.captureVisibleTab; ")}if(o)setTimeout((()=>{pushDataURL(e,t)}),100);else{var s=handleCaptureDelayTime(a);userStop||(0===s?sendMessageToTab(e,{action:"scroll_next",captureTime:a}):setTimeout((()=>{sendMessageToTab(e,{action:"scroll_next",captureTime:a})}),s))}}))}))}function updateShortcutsRequest(e){sendMessageToTab(e,{action:"update_shortcuts",msObj:localStorage.msObj})}function openNewTab(e){getCurrentTab((function(t){var a={url:e};t&&t.incognito||!t?chrome.windows.getAll((function(e){e.forEach((function(e){e.incognito||"normal"!==e.type||(a.windowId=e.id)})),createTabWithInfo(a)})):(a.index=(t?t.index:currentTabIndex||0)+1,a.windowId=t?t.windowId:currentWindowId,createTabWithInfo(a))}))}function createTabWithInfo(e){e&&e.url&&(e.hasOwnProperty("index")&&!e.index&&delete e.index,chrome.tabs.create(e,(function(e){tabids[e.id]=tabid,tabid=e.id,chrome.windows.update(e.windowId,{focused:!0}),sendMessage({action:"closeWin"})})))}function newTab(e){if(isScrollCapturing=!1,currentTemId=0,dataURL)if("selected"==menuType&&sendMessageToTab(tabid,{action:"destroy_selected"}),"true"==localStorage.autoSave)prepareImage();else{if(e&&"gmail"==e.type)var t="edit-react.html?"+e.type+"="+e.tabId;else t="edit-react.html";chrome.tabs.query({active:!0,currentWindow:!0},(function(a){if(a&&a.length){if(e&&e.tabId)var r=a[0].index;else r=a[0].index+1;var o={url:t};a[0].incognito||(o.index=r)}else o={url:t,index:currentTabIndex+1,windowId:currentWindowId};createTabWithInfo(o)}))}else alert("Screen Capture Fail!!")}function prepareImage(){var e,t,a=document.getElementById("tempCanvas"),r=a.getContext("2d"),o=document.getElementById("test_image"),i=(document.getElementById("temp_image"),17),c=function(){var s,l;if(e=o.width,t=o.height,"visible"==type)"selected"==menuType?(s=centerW,l=centerH,S=centerOffX,y=centerOffY):(s=o.width,l=o.height,S=0,y=0),$("#tempCanvas").attr({width:s,height:l}),r.drawImage(o,S,y,s,l,0,0,s,l),"jpg"==localStorage.format?tempDataUrl=a.toDataURL("image/jpeg"):"png"==localStorage.format&&(tempDataUrl=a.toDataURL()),document.getElementById("pluginobj").AutoSave(tempDataUrl,tabtitle.replace(/[#$~!@%^&*();'"?><\[\]{}\|,:\/=+-]/g," "),localStorage.savePath),setTimeout((function(){getCurrentTab((function(e){sendMessageToTab(e.id,{action:"finishAutoSave",path:localStorage.savePath})})),sendMessage({action:"closeWin"})}),1e3);else if("entire"==type||"selected"==type){var d=dataURL,u=j=n=0,p=d.length,g=counter,m=Math.round(p/g);function b(e,a,o,i,c,s,l,p,g){l=u*t,u==m-1&&(o=t-lastH,c=g=lastH),$("#temp_image").attr({src:e}).load((function(){$(this).unbind("load"),r.drawImage(this,a,o,i,c,s,l,p,g),++u>m-1?f():b(d[++n],a,o,i,c,s,l,p,g)}))}function h(){$(a).attr({width:s,height:l})}function f(){if(++j>g-1){var r=document.getElementById("pluginobj");return"jpg"==localStorage.format?tempDataUrl=a.toDataURL("image/jpeg"):"png"==localStorage.format&&(tempDataUrl=a.toDataURL()),r.AutoSave(tempDataUrl,tabtitle.replace(/[#$~!@%^&*();'"?><\[\]{}\|,:\/=+-]/g," "),localStorage.savePath),void setTimeout((function(){getCurrentTab((function(e){sendMessageToTab(e.id,{action:"finishAutoSave",path:localStorage.savePath})})),sendMessage({action:"closeWin"})}),1e3)}j==g-1?(S=e-lastW,T=dw=s-j*e,v=j*e):(S=0,T=dw=e,v=j*e),y=0,w=dh=t,C=0,u=0,n=u+j*m,b(d[n],S,y,T,w,v,C,dw,dh)}if(!scrollBar.x&&scrollBar.y){e-=i,m=p,lastH=t*ratio.y,"selected"==menuType?(scrollBar.realX&&(t-=i),s=centerW):s=e,l=lastH?t*(m-1)+lastH:t*m,h();var S=0,T=dw=e,v=0,y=0,w=dh=t,C=0;b(d[n],S,y,T,w,v,C,dw,dh)}if(scrollBar.x&&!scrollBar.y){t-=i,g=p,lastW=e*ratio.x,"selected"==menuType?(scrollBar.realY&&(e-=i),l=centerH):l=t,s=lastW?e*(g-1)+lastW:e*g,h();S=0,T=dw=e,v=0,y=0,w=dh=t,C=0;!function t(a,o,n,i,c,s,l,u,p,m){s=j*e,j==g-1&&(o=e-lastW,i=u=lastW),$("#temp_image").attr({src:a}).load((function(){$(this).unbind("load"),r.drawImage(this,o,n,i,c,s,l,u,p),j<g-1&&t(d[++j],o,n,i,c,s,l,u,p)}))}(d[n],S,y,T,w,v,C,dw,dh)}if(scrollBar.x&&scrollBar.y){lastW=e*ratio.x,lastH=t*ratio.y,e-=i,t-=i,"selected"==menuType?(s=centerW,l=centerH):(s=lastW?e*(g-1)+lastW:e*g,l=lastH?t*(m-1)+lastH:t*m),h();S=0,T=dw=e,v=0,y=0,w=dh=t,C=0;b(d[n],S,y,T,w,v,C,dw,dh)}}dataURL=[],o.removeEventListener("onload",c,!1),o.src=""};o.onload=c,o.src=dataURL[0]}localStorage.format||(localStorage.format="png"),localStorage.delay_sec||(localStorage.delay_sec=3),localStorage.desktop_delay_sec||(localStorage.desktop_delay_sec=0),localStorage["remove-print-watermark"]||(localStorage["remove-print-watermark"]=!1),localStorage["data-tracking"]||(localStorage["data-tracking"]=!0),localStorage["add-url"]||(localStorage["add-url"]=!1),localStorage["expand-link"]||(localStorage["expand-link"]=!0),localStorage["expand-link-slack"]||(localStorage["expand-link-slack"]=!0),localStorage["expand-link-trello"]||(localStorage["expand-link-trello"]=!0),localStorage["expand-link-asana"]||(localStorage["expand-link-asana"]=!0),localStorage["expand-link-github"]||(localStorage["expand-link-github"]=!0),localStorage["expand-link-jira"]||(localStorage["expand-link-jira"]=!0),localStorage["expand-link-gmail"]||(localStorage["expand-link-gmail"]=!1),localStorage.aws_s&&32!==localStorage.aws_s.length&&(localStorage.aws_s="",localStorage.aws_uid="",localStorage.aws_username=""),localStorage["show-noti"]||(localStorage["show-noti"]=!0),localStorage.popupTab||localStorage.version||(localStorage.popupTab="record"),localStorage["save-as"]||(localStorage["save-as"]=!0),localStorage.allow_remind_mic||(localStorage["allow-remind-mic"]=!0),localStorage.record_mic||(localStorage.record_mic=!0),localStorage.record_countdown||(localStorage.record_countdown=3),localStorage.max_resolution||(window.screen.width*window.devicePixelRatio>3e3?localStorage.max_resolution="1080":localStorage.max_resolution="720"),localStorage["save-location"]?localStorage["save-capture-location"]||(localStorage["save-capture-location"]="local"):(localStorage["save-location"]="cloud",localStorage["save-capture-location"]="cloud"),localStorage.record_tabsound||(localStorage.record_tabsound=!0),localStorage.record_toolbar||(localStorage.record_toolbar=!0),localStorage.reocrd_type||(localStorage.record_type="desktop"),localStorage["gmail-btn"]||(localStorage["gmail-btn"]="true"),$(document).ready((function(){})),localStorage.autoSave="false",chrome.runtime.onMessage.addListener((function(e,t,a){switch(getCurrentTab((function(e){e&&(/chrome-extension:\/\/nlipoenfbbikpbjkfpfillcgkoblgpmj/.test(e.url)||(currentWindowId=e.windowId,currentTabId=e.id,currentTabIndex=e.index))})),t.tab&&-1!=t.tab.id&&"visible"!=e.action&&"selected"!=e.action&&"entire"!=e.action&&"delay"!==e.action||(isScrollCapturing||(menuType=e.action,e.menuType&&(menuType=e.menuType)),actionFrom=e.actionFrom,"visible"!=e.action&&"selected"!=e.action&&"entire"!=e.action&&"delay"!==e.action||(bgRegions=[],contentClip=null,bottomClip=null,topCapturePostion=null),checkLoalStuff()),e.action){case"visible":isScrollCapturing&&"entire"!=e.menuType||("selected"==(menuType=e.menuType)?(type="visible",e.centerW&&(centerW=e.centerW,centerH=e.centerH,e.data&&(centerOffX=e.data.x,centerOffY=e.data.y))):(centerOffY=0,centerOffX=0,centerW=0,centerH=0,userAction="annotate","entire"==menuType&&(isScrollCapturing=!1)),dataURL=[],captureVisibled());break;case"selected":isScrollCapturing||(dataURL=[],captureSelected());break;case"entire":isScrollCapturing||(dataURL=[],centerOffY=0,centerOffX=0,centerW=0,centerH=0,userAction="save",captureEntire());break;case"delay":type="delay",getSelectedTab(checkContentScript);break;case"https":alert("For security reason, Capture Selected Area doesn't work in https pages! Please try other options.");case"insert_script":insertFile("script",tabid,"javascripts/libs/jquery-3.4.0.min.js").then(insertFile("script",tabid,"javascripts/libs/dragresize.js")).then(insertFile("script",tabid,"javascripts/jquery.draggable.js")).then(insertFile("script",tabid,"javascripts/libs/jquery-ui-custom.min.js")).then(insertFile("css",tabid,"stylesheets/selected.css")).then(insertFile("script",tabid,"javascripts/bundles/content.bundle.js")).then((function(){isScrollCapturing||("delay"===type?sendMessageToTab(tabid,{action:"delay-capture",sec:localStorage.delay_sec}):"visible"==type?captureVisible():("entire"==menuType&&(isScrollCapturing=!0),sendMessageToTab(tabid,{action:"init_"+menuType+"_capture",autoOnline:isAutoSaveOnline()})))}));break;case"script_running":isScrollCapturing||("delay"===type?sendMessageToTab(tabid,{action:"delay-capture",sec:localStorage.delay_sec}):"visible"==type?captureVisible():("entire"==menuType&&(isScrollCapturing=!0),sendMessageToTab(tabid,{action:"init_"+type+"_capture",autoOnline:isAutoSaveOnline()})));break;case"check_shortcuts":updateShortcutsRequest(t.tab.id);break;case"update_shortcuts":chrome.tabs.getAllInWindow(null,(function(e){for(var t=0,a=e.length;t<a;t++){var r=e[t],o=r.url;o.match(/https?:\/\/*\/*/gi)&&!o.match(/https:\/\/chrome.google.com\/extensions/i)&&updateShortcutsRequest(r.id)}}));break;case"scroll_next_done":null!=e.userAction&&(userAction=e.userAction),type="entire","selected"!=menuType&&"selected"!=e.menuType||(menuType="selected",e.centerW&&(centerW=e.centerW,centerH=e.centerH,e.data&&(centerOffX=e.data.x,centerOffY=e.data.y)));var r=!1;e.isFirstScroll&&(userStop=!1,r=!0,isSaveOnLine=!1,isScrollCapturing=!0,curentCaptureTabid=t.tab.id,currentWindowHeight=e.windowHeight,bgRegions=e.bgRegions,contentClip=e.contentClip,bottomClip=e.bottomClip,topCapturePostion=e.topCapturePostion,devicePixelRatio=e.devicePixelRatio,scrollCatureTimes=[],dataURL=[],"save"==userAction&&(currentTemId=++temImageId,initImageId(tabtitle,taburl,"selected"==menuType?"entire_selected":"entire",currentTemId,e.mark?actionFrom+" tabid:"+currentTabId+" mark:"+e.mark:actionFrom+" tabid:"+currentTabId))),saveAndScroll(curentCaptureTabid,currentTemId,r);break;case"entire_capture_done":if(counter=e.counter,ratio=e.ratio,scrollBar=e.scrollBar,type="entire",scrollCatureTimes=[],"selected"==menuType&&e.centerW&&(centerW=e.centerW,centerH=e.centerH,e.data&&(centerOffX=e.data.x,centerOffY=e.data.y)),sendMessageToTab(curentCaptureTabid||currentTabId,{action:"restorebar"}),"copy"==userAction)copySelectAction(curentCaptureTabid||currentTabId);else if(isAutoSaveOnline()&&isSaveOnLine&&currentTemId>0){var o=dataURL.length,n=getQueueByImageId(currentTemId);n||(n=new UploadQueue(currentTemId),uploadQueues[currentTemId]=n),handleCurrentCapture(dataURL[o-1],o,!0,currentTemId),currentTemId=0,sendMessageToTab(curentCaptureTabid||currentTabId,{action:"destroy_selected"})}else newTab();break;case"stop-entire-capture":sendMessageToTab(curentCaptureTabid||currentTabId,{action:"stop-entire-capture"});break;case"capture_selected_done":if(currentTemId>0)return;type="visible",menuType="selected",centerH=e.data.h,centerW=e.data.w,centerH<=1&&(centerH=1),centerW<=1&&(centerW=1),centerOffX=e.data.x,centerOffY=e.data.y,null!=e.userAction&&(userAction=e.userAction),dataURL=[],captureVisible();break;case"ready":return sendMessageToTab(tabid,{menuType,type,data:dataURL,taburl,tabtitle,counter,ratio,scrollBar,centerW,centerH,centerOffX,centerOffY}),void(dataURL=[]);case"copy":chrome.experimental.clipboard.executeCopy(tabid,(function(){alert("copied")}));break;case"clearDataURL":dataURL=[];break;case"exit":getCurrentTab((function(e){chrome.tabs.remove(e.id)}));break;case"get_option":a({options:localStorage.msObj});break;case"newtip":if(!localStorage.version||localStorage.version!=currentversion){chrome.browserAction.setBadgeText({text:""}),count=1,window.open("https://www.diigo.com/awe/new-for-awesome-screenshot.html?v="+currentversion),localStorage.version=currentversion,sendMessage({action:"shownew"})}break;case"openNewTab":openNewTab(i=e.url);break;case"openOauthTab":var i=e.url;chrome.tabs.create({url:i}),chrome.tabs.remove(t.tab.id);break;case"enablePriceCompare":enablePriceCompare(),localStorage.show_feature_bar="false";break;case"getShowFeatureBar":a(localStorage.show_feature_bar);break;case"disableShowFeatureBar":localStorage.show_feature_bar="never";break;case"desktop":e.type&&"gmail"==e.type?beginDesktop(t.tab.id):beginDesktop();break;case"record":recordType=e.options.recordType,getCurrentTab((function(e){isNotAcceptedTab(e.url)||"camera"===recordType||(currentRecordingTabId=e.id,insertContentScript(e.id).then((function(){sendMessageToTab(e.id,{action:"insertRecordDiv"})})).catch((function(e){})))})),"camera"!==recordType&&e.options.isRecordCam&&initCamera(e.options.camDeviceId),e.options.isShowToolbar&&(initToolbar(),isShowToolbar=!0),beginRecord(e.options),checkLoalStuff();break;case"gmail-btn":a("true"==localStorage["gmail-btn"]);break;case"close-camera":!0===e.manually&&(isEmbedCamera=!1,tabCameraClosedManually=!0),stopCameraStream();break;case"init-camera":initCamera(localStorage["cam-deviceId"]);break;case"getLocalStorage":var c=e.what,s={};c.forEach((function(e){s[e]="true"===localStorage[e]})),a(s);break;case"stop-stream":videoStream&&(videoStream.stop(),videoStream.getVideoTracks()[0].onended());break;case"checkUserStatus":!currentTemId>0&&getUserSigninStatus((function(e){getCurrentTab((function(t){t&&sendMessageToTab(t.id,{action:"userStatus",userStatus:e||!isAutoSaveOnline()})}))}));break;case"getPersonType":getPersonType((function(e){getCurrentTab((function(t){t&&sendMessageToTab(t.id,{action:"persionType",persionType:e})}))}));break;case"canScroll":contentCanScroll=e.canSroll;break;case"canCapture":!currentTemId>0&&getCurrentTab((function(t){sendMessageToTab(t.id,{action:"canCapture",isCopy:e.isCopy,isUserAction:e.isUserAction})}));break;case"pageReload":t.tab&&tryFinishCapture(t.tab.id,"reload");break;case"recordStyle":var l={};localStorage.recordStyle&&(l=JSON.parse(localStorage.recordStyle)),l[e.shape]||(l[e.shape]={}),e.isColor?l[e.shape].color=e.value:l[e.shape].width=e.value,localStorage.recordStyle=JSON.stringify(l);break;case"getRecordStyle":l={};localStorage.recordStyle&&(l=JSON.parse(localStorage.recordStyle)),getCurrentTab((function(e){e&&sendMessageToTab(e.id,{action:"recordStyle",recordStyle:l})}));break;case"pause-recording":pauseScreenRecording();break;case"resume-recording":resumeScreenRecording();break;case"discard-recording":stopStream(!0);break;case"currentTab":getSelectedTab();break;case"saveImage":handleBase64DataUrl(e.data,e.actionType,e.format);break;case"draw-annotation":isAnnotated||"cloud"!==localStorage["save-location"]||socketClient&&(socketClient.updateAnnotatedFlag(),isAnnotated=!0)}})),chrome.tabs.onActivated.addListener((function(e){e&&e.tabId&&sendMessageToTab(e.tabId,{action:"tabCanScroll"})})),chrome.tabs.onUpdated.addListener((function(e,t,a){"chrome-extension://alelhddbbhepgpmgidjdcjakblofbmce/#"==t.url?sendMessage({name:"loginByGoogle"}):"https://www.awesomescreenshot.com/redirect.html#"!=t.url&&"https://www.awesomescreenshot.com/redirect.html"!=t.url||(chrome.tabs.remove(a.id),a.openerTabId&&chrome.tabs.update(a.openerTabId,{active:!0}),chrome.runtime.sendMessage({name:"awsLoginByGoogle"})),"tab"===currentRecordType?e===currentRecordingTabId&&(isEmbedCamera&&sendMessageToTab(currentRecordingTabId,{action:"setup-camera"}),isShowToolbar&&sendMessageToTab(currentRecordingTabId,{action:"setup-toolbar"})):"desktop"===currentRecordType&&isShowToolbar&&sendMessageToTab(e,{action:"setup-toolbar"}),sendMessageToTab(e,{action:"tabupdate"}),t&&t.status})),chrome.tabs.onRemoved.addListener((function(e){tryFinishCapture(e,"close"),tabids[e]&&chrome.tabs.update(tabids[e],{selected:!0})})),chrome.runtime.onInstalled.addListener((function(e){"install"==e.reason&&"true"===localStorage["expand-link-gmail"]&&(localStorage["expand-link-gmail"]=!1),"update"!==e.reason&&"install"!==e.reason||chrome.tabs.query({},(function(e){e.forEach((function(e){insertContentScript(e.id)}))}))})),localStorage.version||(localStorage.newClickVersion=newClickVersion),localStorage.version&&localStorage.newClickVersion!=newClickVersion&&chrome.browserAction.setBadgeText({text:"New"}),"recording"!==recordingStatus&&chrome.browserAction.getBadgeText({},(function(e){"New"!==e&&chrome.browserAction.setBadgeText({text:""})}));var baseUrl="https://www.awesomescreenshot.com";function beginDesktop(e){chrome.desktopCapture.chooseDesktopMedia(["screen","window"],(function(t){if(t){var a={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxWidth:3840,maxHeight:2160}}};window.navigator.mediaDevices.getUserMedia(a).then((function(t){if(0==currentTemId){if(type="visible",menuType="desktop",centerW=0,e)isSaveOnLine=!1;else{var a=++temImageId;initImageId("Desktop screenshot","","desktop",a)}var r=document.createElement("video");r.setAttribute("autoplay","true"),r.addEventListener("play",(function(){if(parseInt(localStorage.desktop_delay_sec)>0){t.getVideoTracks()[0].onended=function(){desktopCaptureInterval&&(clearInterval(desktopCaptureInterval),chrome.browserAction.setBadgeText({text:""}))};var o=parseInt(localStorage.desktop_delay_sec);chrome.browserAction.setBadgeText({text:o+""}),o--,desktopCaptureInterval=setInterval((function(){0!==o?(chrome.browserAction.setBadgeText({text:o+""}),o--):(clearInterval(desktopCaptureInterval),chrome.browserAction.setBadgeText({text:""}),setTimeout((function(){var o=document.createElement("canvas"),n=o.getContext("2d");o.width=r.videoWidth,o.height=r.videoHeight,n.drawImage(r,0,0,o.width,o.height),dataURL=[];var i=document.createElement("IMG");if(i.src=o.toDataURL(),dataURL.push(i),r.pause(),r.srcObject=null,t.getVideoTracks()[0].stop(),$(r).remove(),$(o).remove(),tabtitle="Desktop screenshot",type="visible",menuType="desktop",centerW=0,isAutoSaveOnline()&&isSaveOnLine){var c=getQueueByImageId(a);c||(c=new UploadQueue(a),uploadQueues[a]=c),handleCurrentCapture(i,1,!0,a)}else e?newTab({type:"gmail",tabId:e}):newTab()}),300))}),1e3)}else setTimeout((function(){var o=document.createElement("canvas"),n=o.getContext("2d");o.width=r.videoWidth,o.height=r.videoHeight,n.drawImage(r,0,0,o.width,o.height),dataURL=[];var i=document.createElement("IMG");if(i.src=o.toDataURL(),dataURL.push(i),r.pause(),r.srcObject=null,t.getVideoTracks()[0].stop(),$(r).remove(),$(o).remove(),tabtitle="Desktop screenshot",type="visible",menuType="desktop",centerW=0,isAutoSaveOnline()&&isSaveOnLine){var c=getQueueByImageId(a);c||(c=new UploadQueue(a),uploadQueues[a]=c),handleCurrentCapture(i,1,!0,a)}else e?newTab({type:"gmail",tabId:e}):newTab()}),300)}),!1),r.srcObject=t}}),(function(e){alert(e)}))}}))}chrome.cookies.get({url:baseUrl,name:"screenshot_personal_uid"},(function(e){e&&localStorage.version!=currentversion&&refreshCookie(),localStorage.version=currentversion}));var createLogger=function(e){if("red"===e);else;},log_red=createLogger("red"),log=createLogger();function initVideo(e){socketClient&&(socketClient.active=!1),socketClient=new SocketClient(e),socketClient.connect()}function getDevices(e){return e.filter((function(e,t,a){return""!==e.label&&a.findIndex((function(t){return t.deviceId===e.deviceId}))===t}))}function checkLoalStuff(){chrome.cookies.get({url:baseUrl,name:"screenshot_personal_uid"},(function(e){uploadUserStuff(e)}))}function uploadUserStuff(e){var t="rateInitKey";e?localStorage[t]||(localStorage[t]=!0,chrome.storage.sync.get(["captureCount","clickNo","neverShow"],(function(e){$.ajax({type:"POST",contentType:"application/json",url:"https://www.awesomescreenshot.com/api/v1/user/stuff",data:JSON.stringify({type:"chromeFiveStar",clickeNo:(!!e.clickNo&&e.clickNo)+"",neverShow:(!!e.neverShow&&e.neverShow)+""}),success:function(e){e.code},error:function(e){}})}))):localStorage.removeItem(t)}function getClientStr(){return/Edg/.test(navigator.userAgent)?"Edge extension":"Chrome extension"}function refreshUserInfo(){var e="https://www.awesomescreenshot.com";chrome.cookies.getAll({url:e},(function(t){if(t){for(var a="",r=0,o=t.length;r<o;r++)"screenshot_personal_uid"===t[r].name&&(a=t[r].value);a?$.ajax({method:"GET",url:e+"/api/v1/user/einfo"}).done((function(e){var t=parseInt(e.data.premiumLevel),r=e.data.videoTotalAllCreated,o=e.data.newPremium;chrome.storage.local.set({userinfo:{uid:a,newPremium:o,premiumLevel:t,totalVideoCount:r}})})):chrome.storage.local.remove("userinfo")}}))}localStorage.video_need_complete&&(SocketClient.httpComplete(localStorage.video_need_complete),localStorage.video_need_complete=""),"true"===localStorage.has_setup||localStorage.version||getAllAudioVideoDevices((function(e){var t=getDevices(e.audioInputDevices);chrome.cookies.get({url:baseUrl,name:"screenshot_personal_uid"},(function(a){a?0!==e.audioInputDevices.length&&0===t.length&&chrome.tabs.create({url:"/setup-react.html?from=install&isSignIn=true"}):e.audioInputDevices.length?t.length?chrome.tabs.create({url:"/setup-react.html?from=install&isGranted=true"}):chrome.tabs.create({url:"/setup-react.html?from=install"}):chrome.tabs.create({url:"/setup-react.html?from=install&isGranted=true"}),localStorage.has_setup=!0}))})),checkLoalStuff(),refreshUserInfo();